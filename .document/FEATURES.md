# Features

This document describes the key features implemented in this project.

---

<details>
  <summary>Table of Contents</summary>

- [API documentation](#api-documentation)
- [Error handling](#error-handling)
  - [Exception ID](#exception-id)
- [Debug level logging](#debug-level-logging)
- [Request ID generation](#request-id-generation)

</details>

## API documentation

The project uses [OpenAPI](https://swagger.io/specification/) for API documentation. The [openapi.yaml](../openapi.yaml) file in the root directory is generated by the [Springdoc OpenAPI Maven plugin](https://springdoc.org/plugins.html#_maven_plugin) with the following command:

```mvn clean verify -Popenapi```

When the application is running, the spec is also available at [http://localhost:8080/api-docs](http://localhost:8080/api-docs).

## Error handling

The project uses [Spring Boot's `@ControllerAdvice`](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-controller-advice) to handle exceptions in a centralized manner. [GlobalExceptionHandler.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/exception/GlobalExceptionHandler.kt) is responsible for catching exceptions and converting them into appropriate HTTP responses ([ErrorDTO.kt](../template-project-api/src/main/kotlin/com/example/templateproject/api/dto/ErrorDTO.kt)).

Example error response:
```json
{
  "id": "ea8130450e7c09c",
  "message": "Invalid request content.",
  "details": {
    "name": [
      "must be between 3 and 20 characters"
    ]
  },
  "stackTrace": "..."
}
```

The `ErrorDTO` contains the following fields:
- `id`: A unique identifier for the error, generated based on the exception's stack trace. See details below.
- `message`: A description of the error.
- `details`: Optional field that contains additional details about the error.
- `stackTrace`: Optional field that contains the stack trace of the exception. This is not included by default to avoid exposing sensitive information in production. It is controlled by the `app.stack.trace.enabled` property and it can be requested by using the `stackTrace=true` query parameter.


### Exception ID

When an exception occurs, an ID is generated and included in the error response. This ID can be used to track the exception in the logs and dashboards making it easier to investigate and debug issues.

The ID is generated from exception's stack trace based on the following algorithm:

1. Find the first project related class from the stack trace.
2. Create a string by concatenating:
    - The canonical name of the exception class
    - The class name where the exception occurred
    - The method name where the exception occurred
3. Generate an MD5 hash of the string.
4. Use the first 15 characters of the hash.

See the [ExceptionIdGenerator.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/exception/ExceptionIdGenerator.kt) for the implementation details.

For example, if `E` exception occurred in `C` class' `M` method, the `ID` would be generated with this formula:

```
ID = MD5(E + C + M).substring(0, 15)
```

## Debug level logging

Debug level logging can be enabled for certain HTTP requests by meeting the following conditions:
1. The `app.debug.logging.enabled` property must be set to `true` in the `application.properties` file.
2. The request must contain a predefined HTTP header and value. See details in [DebugHeaderFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/filter/DebugHeaderFilter.kt).

By default, debug logging is enabled only for application packages. The list of packages can be extended in the `application.properties` file using the `app.debug.logging.package.list` property. E.g.:

```
app.debug.logging.package.list=org.hibernate,org.springframework.data
```

The feature uses the MDC (Mapped Diagnostic Context) and Logback's MDCFilter. See [logback-spring.xml](../template-project-web/src/main/resources/logback-spring.xml) for the configuration and [DebugLoggingTurboFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/DebugLoggingTurboFilter.kt) for the implementation details.

## Request ID generation

The project generates a unique request ID for each incoming HTTP request. This ID is included in the response headers (`X-Request-ID`) and can be used to trace the request in the logs.

If the request already contains a `X-Request-ID` header, that value will be used instead of generating a new one.

The logic can be found in the [RequestIdFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/filter/RequestIdFilter.kt) class.

> [!NOTE]
> This feature is managed by the `management.otlp.tracing.export.enabled` property in the `application.properties` file. If set to `true`, a higher level tracing solution is used and request ID generation is not required. See [OBSERVABILITY.md](OBSERVABILITY.md) for more details.
