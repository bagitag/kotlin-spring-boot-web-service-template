# Features

<details>
  <summary>Table of Contents</summary>

- [API documentation](#api-documentation)
- [Error handling](#error-handling)
  - [Exception ID](#exception-id)
- [Debug level logging](#debug-level-logging)
- [Request ID generation](#request-id-generation)

</details>

## API documentation

The project uses [OpenAPI](https://swagger.io/specification/) for API documentation. The [openapi.yaml](../openapi.yaml) file, that can be found in the root directory, is generated by the [Springdoc OpenAPI Maven plugin](https://springdoc.org/plugins.html#_maven_plugin) with the following command:

```mvn clean verify -Popenapi```

Or it can be reached directly at [http://localhost:8080/api-docs](http://localhost:8080/api-docs) when the application is running.

## Error handling

The project uses [Spring Boot's `@ControllerAdvice`](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-controller-advice) to handle exceptions in a centralized manner. [GlobalExceptionHandler.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/exception/GlobalExceptionHandler.kt) is responsible for catching exceptions and converting them into appropriate HTTP responses ([ErrorDTO.kt](../template-project-api/src/main/kotlin/com/example/templateproject/api/dto/ErrorDTO.kt)).

```json
{
  "id": "ea8130450e7c09c",
  "message": "Invalid request content.",
  "details": {
    "name": [
      "must be between 3 and 20 characters"
    ]
  },
  "stackTrace": "..."
}
```

The `ErrorDTO` contains the following fields:
- `id`: A unique identifier for the error, generated based on the exception's stack trace. See details below.
- `message`: The message that describes the error.
- `details`: Optional field that contains any additional details about the error.
- `stackTrace`: Optional field that contains the stack trace of the exception. This field is not included by default to avoid exposing sensitive information in production environments. It is controlled by the `app.stack.trace.enabled` property and it needs to be specifically requested by the client by using the `stackTrace=true` query parameter.


### Exception ID
 
When an exception occurs, an ID is generated which is then included in the error response. This ID can be used to track the exception in the logs and dashboards making it easier to investigate and debug issues.

The ID is generated based on exception's stack trace, based on the following algorithm:

1. Get the first project related class from the stack trace.
2. Create a string by concatenating:
    - The canonical name of the exception class
    - The class name where the exception occurred
    - The method name where the exception occurred
3. Generate an MD5 hash of the string.
4. Take the first 15 characters of the hash.

See the [ExceptionIdGenerator.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/exception/ExceptionIdGenerator.kt) for the implementation details.

For example, if `E` exception occurred in `C` class' `M` method, the `ID` would be generated with this formula:

```
ID = MD5(E + C + M).substring(0, 15)
```

## Debug level logging

It is possible to turn on debug level logging for specific HTTP requests. If a request contains the predefined HTTP header and value, debug level logging will be enabled for that request.

The logic for handling the debug header is implemented in the [DebugHeaderFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/filter/DebugHeaderFilter.kt) class.

The feature uses the MDC (Mapped Diagnostic Context) and Logback's MDCFilter for managing the debug level logging. See [logback-spring.xml](../template-project-web/src/main/resources/logback-spring.xml) for the configuration and 
[DebugLoggingTurboFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/DebugLoggingTurboFilter.kt) for the implementation details.

## Request ID generation

The project generates a unique request ID for each incoming HTTP request. This ID is included in the response headers (`X-Request-ID`) and can be used to trace the request in the logs.

If the request already contains a `X-Request-ID` header, its value will be used instead of generating a new one.

The logic can be found in the [RequestIdFilter.kt](../template-project-web/src/main/kotlin/com/example/templateproject/web/configuration/filter/RequestIdFilter.kt) class.

[!NOTE]
This feature is managed by the `management.otlp.tracing.export.enabled` property in the `application.properties` file. If it is `true` that means a higher level tracing solution is used, so there is no need to generate a request ID.

