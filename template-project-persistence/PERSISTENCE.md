# Persistence module

This module manages application data and database connections.
The primary supported database is PostgreSQL.

---

<details>
  <summary>Table of Contents</summary>

- [Technology Stack](#technology-stack)
- [Features](#features)
  - [Database change management](#database-change-management)
  - [Entity auditing](#entity-auditing)
- [Database configuration](#database-configuration)

</details>

## Technology Stack

- Hibernate
- Spring Data JPA
- JPA Query Methods
- Liquibase
- PostgreSQL
- H2 (for development)

## Features

### Database change management

The project uses [Liquibase](https://www.liquibase.org/) for database management. Schema changes are located under the `persistence/src/main/resources/liquibase` directory.

### Entity auditing

The project uses [Spring Data JPA Auditing](https://docs.spring.io/spring-data/jpa/reference/auditing.html) to automatically populate auditing fields such as `createdDate` and `lastModifiedDate` in the entities. See details in [BaseEntity.kt](src/main/kotlin/com/example/templateproject/persistence/entity/BaseEntity.kt).

On the other hand, with the help of the JPA entity lifecycle events, history records are inserted into the `*_history` tables to track changes made to the entities. Details can be found in [EntityChangeListener.kt](src/main/kotlin/com/example/templateproject/persistence/configuration/EntityChangeListener.kt).

## Database configuration

The database configuration can be found in the `persistence-\[spring-profile].properties` files.

### Dev profile

- Uses an in-memory H2 database that is created automatically when the application starts.
- Tables are generated by Hibernate from the entity classes.
- Test data is loaded from [data.sql](src/main/resources/data.sql).
- Logging of SQL statements and session metrics are enabled.

### Docker profile

- Uses a PostgreSQL database that is started as a Docker container based on the [docker-compose-dev.yml](../docker-compose-dev.yml) file.
- Database schema changes are managed by Liquibase using [changelog-root.xml](src/main/resources/liquibase/changelog-root.xml).
