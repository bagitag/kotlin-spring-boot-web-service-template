# Persistence module

This module is responsible for managing the data and the database connection.
The supported database is PostgreSQL.

<details open>
  <summary>Table of Contents</summary>

- [Technology Stack](#technology-stack)
- [Database configuration](#database-configuration)
- [Features](#features)

</details>

## Technology Stack

- Hibernate
- Spring Data JPA
- JPA Query Methods
- Liquibase
- PostgreSQL
- H2 (for development)

## Database configuration

The database configuration can be found in the **persistence-\[spring-profile].properties** files.

### Dev profile

- Uses an in-memory database (H2) that is automatically created when the application starts.
- The tables are generated by Hibernate based on the entities.
- Test data is loaded from the [data.sql](src/main/resources/data.sql) file.
- Logging the executed SQL queries and session metrics are enabled.

### Docker profile

- Uses a PostgreSQL database that is started in a Docker container based on the [docker-compose-dev.yml](../docker-compose-dev.yml) file.
- The tables are generated by Liquibase based on the [changelog-root.xml](src/main/resources/liquibase/changelog-root.xml) file.

## Features

### Database change management

The project uses [Liquibase](https://www.liquibase.org/) for database management. The migration files are located in the `persistence/src/main/resources/liquibase` directory.

### Entity auditing

The project uses [Spring Data JPA Auditing](https://docs.spring.io/spring-data/jpa/reference/auditing.html) to automatically populate auditing fields such as `createdDate` and `lastModifiedDate` in the entities. See details in [BaseEntity.kt](src/main/kotlin/com/example/templateproject/persistence/entity/BaseEntity.kt).

On the other hand, with the help of the JPA entity lifecycle events, history records are inserted into the `*_history` table to track changes made to the entities. Details can be found in [EntityChangeListener.kt](src/main/kotlin/com/example/templateproject/persistence/configuration/EntityChangeListener.kt).
