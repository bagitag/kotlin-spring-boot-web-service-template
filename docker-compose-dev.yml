name: template-app-dev-setup
services:
  database:
    image: postgres:latest
    environment:
      - POSTGRES_DB=example
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=12345
    ports:
      - "5432:5432"
    networks:
      - example-network

  pgAdmin:
    image: dpage/pgadmin4:latest
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=12345
    ports:
      - "8070:80"
    networks:
      - example-network

  prometheus:
    image: prom/prometheus:latest
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - example-network

  grafana:
    image: grafana/grafana:latest
    configs:
      - source: grafana_datasource_config
        target: /etc/grafana/provisioning/datasources/datasources.yml
      - source: grafana_dashboard_config
        target: /etc/grafana/provisioning/dashboards/main.yaml
    volumes:
      - ./.grafana/example-dashboard.json:/var/lib/grafana/dashboards/dashboard.json
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - example-network

  service:
    image: mock/jsonplaceholder:latest
    build:
      dockerfile_inline: |
        FROM node:latest
        RUN npm install -g json-server
        WORKDIR /data
        EXPOSE 80
        ENTRYPOINT ["sh", "-c", "json-server -p 80 db.json"]
    configs:
      - source: service_config
        target: /data/db.json
    ports:
      - "8060:80"

networks:
  example-network:
    driver: bridge

configs:
  prometheus_config:
    content: |
      scrape_configs:
        - job_name: 'spring-actuator'
          metrics_path: '/actuator/prometheus'
          scrape_interval: '10s'
          static_configs:
            - targets: ['host.docker.internal:8080']
              labels:
                application: 'template-app'

  grafana_datasource_config:
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          isDefault: true
          editable: false

  grafana_dashboard_config:
    content: |
      apiVersion: 1
      providers:
        - name: Dashboard provider
          allowUiUpdates: true
          options:
            path: /var/lib/grafana/dashboards
            foldersFromFilesStructure: true

  service_config:
    content: |
      {
        "users": [
          { "id": 1, "name": "Leanne Graham", "username": "Bret", "email": "Sincere@april.biz" },
          { "id": 2, "name": "Ervin Howell","username": "Antonette", "email": "Shanna@melissa.tv" }
        ],
        "posts": [
          { "userId": 1, "id": 1, "title": "sunt aut", "body": "quia et suscipit\nsuscipit recusandae" },
          { "userId": 1, "id": 2, "title": "qui est esse", "body": "est rerum tempore vitae\nsequi sint nihil" },
          { "userId": 1, "id": 3, "title": "ea molestias quasi", "body": "et iusto sed quo iure\nvoluptatem occaecati"},
          { "userId": 2, "id": 11, "title": "et ea vero", "body": "delectus reiciendis molestiae occaecati non minima"}
        ]
      }
